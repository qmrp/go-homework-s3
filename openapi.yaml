openapi: 3.0.0
info:
  title: Huayi IM
  version: v1.0.0
  description: |-
    # 功能

    本项目要求开发者实现一个即时聊天系统，支持单聊和基于话题的群聊。

    # 接口

    开发者需实现一些常规的 RESTful APIs 以及一个 Websocket API。

    # 消息

    用户向另一个用户发送消息，或者发送关于 topic 的消息，总是通过 HTTP 接口发送。
    服务端向用户推送消息（服务端转发的来自其他用户的消息和系统消息）总是通过 Websocket。

    消息体中用 `from` 表示消息的发送者，`to` 表示消息的接收者。

    ```json
    {
      "from": "Harry",
      "to": ["Ron", "Hermione"]
    }
    ```

    如上示例表示 Harry 将消息发送给 Ron 和 Hermione（这不是群聊，是批量发送）。

    服务端接收到来自 Harry 的这则上行消息后，会检查 `to` 列表，然后将消息分别转发给 Ron 和 Hermione。
    当然，这其中还有些检查 Ron 和 Hermione 在线状态等流程不题。

    如果消息体中有 `topic` 则一般表示群聊（系统消息也会有 topic 字段但不属于群聊）。


    ```json
    {
      "from": "Harry",
      "to": ["Ron", "Hermione"],
      "topic": "philosophers_stone"
    }
    ```

    当服务端接收到 Harry 的这则消息，会将消息转发给**所有参与**了 "philosophers_stone" 这个话题的人。
    **注意**，此处不仅仅要将消息转发给 Ron 和 Hermione，而是**所有参与了该 topic 的人**。
    此处的 `to` 字段仅仅表示提及，相当于即时聊天 APP 中用 `@username` 提及某人。

security:
  - bearerAuth: []
paths:
  /healthz:
    get:
      operationId: healthz
      summary: 健康检查
      description: 返回 200 OK 即表示服务已准备好。
      security: []
      responses:
        200:
          description: OK
        400:
          $ref: "#/components/responses/default"
        default:
          $ref: "#/components/responses/default"
  /api/login:
    post:
      operationId: login
      summary: 用户登录
      description: |-
        用户凭借 username 登录，无须密码（为简化项目）。
        用户正确登录后，会在响应体中返回 sid。
        客户端后续使用 Authorization: Bearer <sid> 对其他 HTTP 接口进行访问；
        WebSocket 握手使用 query 参数 sid（`/api/ws?sid=...`）。

        **限制**
        - 同一时刻同一用户只能在一处登录。发生多处登录时，后登陆客户端会将先登录的挤下线，先登录的客户端的任何请求都应当返回 401；如果先登录的客户端与服务端存续 Websocket 连接则需要由服务端主动关闭.
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                username:
                  $ref: '#/components/schemas/username'
      responses:
        200:
          description: OK - 登录成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LoginResponse'
        400:
          $ref: "#/components/responses/default"
        401:
          $ref: "#/components/responses/Unauthorized"
        default:
          $ref: "#/components/responses/default"
  /api/logout:
    post:
      operationId: logout
      summary: 用户登出
      description: |-
        用户登出后,会话应当失效。
      responses:
        200: { description: OK }
        400:
          $ref: "#/components/responses/default"
        default:
          $ref: "#/components/responses/default"
  /api/users:
    get:
      operationId: getUsers
      summary: 查询用户列表
      description: 查询用户列表
      parameters:
        - in: query
          required: false
          name: online
          schema:
            type: boolean
          description: |-
            - `true`: 筛选在线的 Users
            - `false` 或不传: 查询所有 Users
      responses:
        200:
          description: Success
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/ListResponse"
                  - type: object
                    properties:
                      list:
                        type: array
                        items:
                          type: object
                          properties:
                            username:
                              $ref: '#/components/schemas/username'
        400: { $ref: "#/components/responses/default" }
        default: { $ref: "#/components/responses/default" }
  /api/topics:
    get:
      operationId: getTopics
      summary: 查询话题列表
      description: 查询话题列表
      responses:
        200:
          description: Success
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/ListResponse"
                  - type: object
                    properties:
                      list:
                        type: array
                        items:
                          type: object
                          properties:
                            topic:
                              $ref: '#/components/schemas/topic'
        400: { $ref: "#/components/responses/default" }
        default: { $ref: "#/components/responses/default" }
    post:
      operationId: createTopic
      summary: 创建话题
      description: |-
        话题必须先创建才能使用。
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                topic:
                  $ref: '#/components/schemas/topic'
      responses:
        200: { description: OK }
        400:
          $ref: "#/components/responses/default"
        default:
          $ref: "#/components/responses/default"
  /api/topics/{topic}:
    delete:
      operationId: deleteTopic
      summary: 删除话题
      description: |-
        删除话题。

        注意删除话题的前提是该话题存在，否则返回 404.

        所有用户都可以删除任何话题。

        一旦话题被删除，其相关的消息都会被删除，即便此时还有未下发的消息或离线消息。

        同名话题可以随时被创建回来，但之前被删除的消息不可恢复了。

        删除话题会触发系统通知，系统会向话题的所有相关方发送下行消息通知话题已被删除。
      responses:
        200: { description: OK }
        400:
          $ref: "#/components/responses/default"
        default:
          $ref: "#/components/responses/default"
  /api/topics/{topic}/actions/join:
    post:
      operationId: joinTopic
      summary: 显式地加入话题
      description: |-
        显式地加入话题。

        注意加入话题的前提是该话题存在，否则返回 404.
      responses:
        200: { description: OK }
        400:
          $ref: "#/components/responses/default"
        default:
          $ref: "#/components/responses/default"
  /api/topics/{topic}/actions/quit:
    post:
      operationId: quitTopic
      summary: 退出话题
      description: |-
        退出话题。

        注意退出话题的前提是该话题存在，否则返回 404.

        无论 User 是否加入了该话题，使用本接口退出该话题都是安全的。
        也就是说即便用户没有加入该话题，使用本接口退出话题也不会报错。

        用户退出话题后，除非有人再在话题中提及它或它重新加入话题，否则服务端不会再向其推送话题相关的消息了。
      responses:
        200: { description: OK }
        400:
          $ref: "#/components/responses/default"
        default:
          $ref: "#/components/responses/default"
  /api/messages:
    post:
      operationId: sendMessage
      summary: 发送消息
      description: |-
         发送消息。
      requestBody:
        required: true
        content:
          application/json:
            schema:
              oneOf:
                - $ref: '#/components/schemas/P2PUpMsg'
                - $ref: '#/components/schemas/P2TUpMsg'
      responses:
        200: { description: OK }
        400:
          $ref: "#/components/responses/default"
        default:
          $ref: "#/components/responses/default"
  /api/ws:
    get:
      operationId: ws
      summary: Websocket 握手
      description: |-
        Websocket 握手.

        本接口必须通过 query 参数 sid 进行握手鉴权（`/api/ws?sid=...`）。

        由于 Websocket 是长连接双工的，用 Openapi 3 文档不便描述，需要用 AsyncAPI，
        而 AsyncAPI 比较复杂而我们的需求比较简单，因此本文档采用 requestBody 来描述 Websocket 连接上的各种消息类型。
      security: []
      parameters:
        - in: query
          required: true
          name: sid
          schema:
            $ref: '#/components/schemas/sid'
          description: 登录接口返回的 sid，会话标识
      requestBody:
        required: false
        content:
          application/json:
            schema:
              oneOf:
                - $ref: '#/components/schemas/Ping'
                - $ref: '#/components/schemas/Pong'
                - $ref: '#/components/schemas/Ack'
                - $ref: '#/components/schemas/P2PDown'
                - $ref: '#/components/schemas/P2TDown'
                - $ref: '#/components/schemas/SystemDownTopicIsDeleted'
                - $ref: '#/components/schemas/SystemDownTopicNotFound'
      responses:
        200: { description: OK }
        400:
          $ref: "#/components/responses/default"
        default:
          $ref: "#/components/responses/default"
components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: sid
  schemas:
    sid:
      description: 会话标识，由登录接口返回；可用于 Authorization: Bearer <sid> 或 WebSocket ?sid=...
      type: string
      minLength: 1
    LoginResponse:
      type: object
      properties:
        sid:
          $ref: '#/components/schemas/sid'
        username:
          $ref: '#/components/schemas/username'
      required: [sid, username]
      additionalProperties: false
    username:
      description: 用户名，4-30个字符，只能包含字母、数字、下划线和连字符
      type: string
      pattern: "^[a-zA-Z0-9_-]{4,30}$"
    topic:
      description: |-
        话题，4-30个字符，只能包含字母、数字、下划线和连字符。

        注意：User 加入 topic 是隐式地、自动的。
        - 当 User 发送关于某 topic 的消息，则视作自动加入了该 topic，后续能收到该 topic 上的消息。
        - 当 User 在任意 topic 的消息中被提及(其 username 出现在 .to 列表中)，也视作该 User 自动加入了该 topic，后续能收到该 topic 上的消息。
      type: string
      pattern: "^[a-zA-Z0-9_-]{4,30}$"
    Error:
      type: object
      required:
        - error
      properties:
        error:
          type: string
          description: 描述错误信息
    ListResponse:
      type: object
      properties:
        total:
          type: integer
        list:
          type: array
      required: [total, list]
      additionalProperties: false
    P2PUpMsg:
      type: object
      title: 一对一上行消息
      description: |-
        上行一对一消息，即客户端发送给服务端的单聊消息。

        **字段说明**
        - `from`: 消息的发送者 username
      properties:
        message-type:
          type: string
          enum:
            - message
          description: 消息类别
        from:
          $ref: '#/components/schemas/username'
        to:
          type: array
          items:
            $ref: '#/components/schemas/username'
          description: |-
            消息接收者列表。
            注意此处是列表，表示可以批量发送同一则消息给多人。
        content-type:
          type: string
          enum:
            - text/plain
          description: 消息内容格式
        content:
          type: string
          description: 消息内容
      required:
        - message-type
        - from
        - to
        - content-type
        - content
      additionalProperties: false
    P2TUpMsg:
      type: object
      title: 群聊上行消息
      description: |-
        上行群聊消息，即客户端发送给服务端的群聊消息。
        与`一对一上行消息`的关键区别在于是否有`topic`.

        **字段说明**
        - `from`: 消息的发送者 username
      properties:
        message-type:
          type: string
          enum:
            - message
          description: 消息类别
        from:
          $ref: '#/components/schemas/username'
        to:
          items:
            $ref: '#/components/schemas/username'
          description: |-
            消息提及者列表。
            注意此处与`一对一上行消息`不同，此处仅表示在群消息中提及，而不是发送单聊消息，
            相当于 IM 应用的群聊中用 `@username` 来强调提及某 User。
        topic:
          $ref: '#/components/schemas/topic'
        content-type:
          type: string
          enum:
            - text/plain
          description: 消息内容格式
        content:
          type: string
          description: 消息内容
      required:
        - message-type
        - from
        - to
        - topic
        - content-type
        - content
      additionalProperties: false
    Ping:
      title: 上行心跳
      properties:
        message-type:
          type: string
          enum:
            - ping
        message-id:
          type: integer
          description: 消息 Id. 只有 ping 和 pong 消息才有 Id.
        from:
          $ref: '#/components/schemas/username'
    Pong:
      title: 下行心跳
      properties:
        message-type:
          type: string
          enum:
            - pong
        message-id:
          type: integer
          description: 消息 Id. 只有 ping 和 pong 消息才有 Id.
        to:
          $ref: '#/components/schemas/username'
    Ack:
      title: 心跳确认
      description: |-
        服务端接收到客户端的 ping 消息应当进行确认。
        客户端接收到服务端的 pong 消息应当进行确认。
        此为确认消息的 payload.
        其 `ack-id` 表示对哪个 ping 或 pong 消息进行确认。
      properties:
        message-type:
          type: string
          enum:
            - ack
        ack-id:
          type: integer
          description: |-
            ping 或 pong 消息的 `message-id` 的回填，表示对哪个 ping 或 pong 消息的确认。
    P2PDown:
      title: 一对一单聊下行消息
      description: |-
        一对一单聊的下行消息格式。
      properties:
        message-type:
          type: string
          enum:
            - message
        from:
          $ref: '#/components/schemas/username'
        to:
          type: array
          items:
            $ref: '#/components/schemas/username'
          minimum: 1
          maxItems: 1
        content-type:
          type: string
          enum:
            - text/plain
        content:
          type: string
          description: 消息内容文本
    P2TDown:
      title: 群聊下行消息
      description: |-
        群聊的下行消息格式。
      properties:
        message-type:
          type: string
          enum:
            - message
        from:
          $ref: '#/components/schemas/username'
        to:
          type: array
          items:
            $ref: '#/components/schemas/username'
          minimum: 1
        topic:
          $ref: '#/components/schemas/topic'
        content-type:
          type: string
          enum:
            - text/plain
        content:
          type: string
          description: 消息内容文本
    SystemDownTopicIsDeleted:
      title: 系统下发消息-TopicIsDeleted
      description: |-
        系统下发的消息，当 topic 被删除时下发此消息，告知客户端 topic 已经被删除了。
        客户端可能会根据消息作出一些反应。
      properties:
        message-type:
          enum:
            - system
        topic:
          type: string
          enum:
            - __topic_is_deleted__
        content-type:
          type: string
          enum:
            - application/json
        content:
          type: object
          properties:
            topic:
              $ref: "#/components/schemas/topic"
    SystemDownTopicNotFound:
      title: 系统下发消息-TopicNotFound
      description: |-
        当客户端在消息中使用了不存在的 topic，服务端将下发本消息，并且不会做任何转发。
      properties:
        message-type:
          enum:
            - system
        topic:
          type: string
          enum:
            - __topic_not_found__
        content-type:
          type: string
          enum:
            - application/json
        content:
          type: object
          properties:
            topic:
              $ref: "#/components/schemas/topic"

  responses:
    default:
      description: Error response
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/Error"
    Unauthorized:
      description: Unauthorized - 用户未登录
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/Error"
          example:
            error: "未登录或会话已过期"
